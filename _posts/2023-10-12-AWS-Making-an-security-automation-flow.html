---
layout: post
title: "AWS - Security Automation - Exp 1"
subtitle: "AWS: Making an Security Automation Flow with Event Bridge, Lambda, IAM."
date: 2023-09-13 23:45:13 -0400
background: '/img/posts/01.jpg'
---

<p> Hello All,</p>
<p>Welcome to this post </p>

<p>In this post, we will discuss the Server-Side Request Forgery (SSRF) vulnerability in the context of AWS Cloud. The primary goal of this post is to demonstrate how AWS Config can be used to automatically detect and remediate this issue.</p>

<p>SSRF Vulnerability is a server-side vulnerability that enables an attacker to exploit a vulnerable server to make requests to internal or third-party servers in order to access data. In the context of AWS Cloud, the attacker's main objective is to obtain the temporary credentials assigned to an EC2 instance by attempting to access the metadata URL.</p>

<p>For demonstration purposes, I hosted vulnerable code on an EC2 instance and attempted to retrieve the credentials. You can see how I successfully obtained the temporary credentials.</p>

<img src="../../../media/ssrf.png" width="" height="">

<p> We were able to retrieve these temporary credentials because the image was Ubuntu, and it was using IMDSv1. To address this issue, we need to upgrade to IMDSv2. </p>

<h2>Why IMDSv2 is Important?</h2>

<p>IMDSv2 uses PUT requests and requires an authentication token in the header, as well as utilizing OPTIONS requests, which disrupts the SSRF chain flow.</p>

<p>Now, we need a process to detect the weak configuration and automatically remediate it.</p>

<h2>AWS Config</h2>

<p>AWS Config is a managed service provided by AWS that detects non-compliance configurations. Based on these non-compliance configurations, remediations can be applied. One of the notable aspects of AWS is its granularity, allowing you to achieve the same task in multiple, cost-effective ways.</p>


<p>In this post, we will acheive the same task by using 2 methods </p>

<p>
	AWS Config Auto-remediation<br>
	AWS Config with Event Bridge and Lambda
</p>

<h2>AWS Config Auto-Remediation</h2>

<p>This method is straightforward. You select a rule and specify its remediation. In this case, we need to upgrade to IMDSv2 to remediate the use of IMDSv1 in instances. We choose the remediation 'AWSConfigRemediation-EnforceIMDSv2'.</p>

<p>We also need to create roles that allow Config to access EC2 instances and assign the role ARN to the rule. That's all that's required. Now, whenever you create an instance with IMDSv1 enabled, this rule will detect it, mark it as non-compliant, and automatically run remediation to upgrade it to IMDSv2.</p>


<img src="../../../media/non-comliant.png" width="" height="">

<p>We created an EC2 instance with the default IMDSv1 support, as shown in the figure.</p>

<img src="../../../media/instanc_IMDS Optional.png" width="" height="">

<p>Once the instance is created, the Config rule will detect the configuration as non-compliant, and the status tab will show 'Action Executed Successfully' after the auto-remediation.</p>

<p>Upon refreshing, you will see the version updated automatically, as shown in the figure below.</p>

<img src="../../../media/imdsv2_success2.png" height="" width="">

<h2>AWS Config, Event Bridge, Lambda</h2>

<p>In this approach, we removed auto-remediation from the rule and created an event in Event Bridge. I also created a Lambda function that lists all the instances and upgrades IMDSv1 to IMDSv2.</p>

<p>
	Created a Event Bridge Rule, that will trigger on event based on Non-Compliant issues detected by AWS Config.
</p>

<img src="../../../media/way 2 - eventbridgerule.png" height="" width="">

<p>Created Lambda that will list all the instances and will modify the IMDS version. Note this function could be improved in more ways but for now let it be. </p>

<pre><code> 

	import boto3

def lambda_handler(event, context):
    ec2_client = boto3.client('ec2')
    instances = ec2_client.describe_instances(
        Filters=[
            {
                'Name': 'instance-state-name',
                'Values': ['running']
            }
        ]
    )
    for reservation in instances['Reservations']:
        for instance in reservation['Instances']:
            instance_id = instance['InstanceId']
            
            ec2_client.modify_instance_metadata_options(
                InstanceId=instance_id,
                HttpTokens='required'
            )
            print("IMDSv2 activation initiated for instance ", instance_id)
    return "IMDSv2 activation completed for all running instances."

</code></pre>

<p>As you can see, this code lists all the instances and updates the IMDS configuration by setting HttpTokens to 'required'.</p>

<p>It's crucial to create the required permissions and roles for this setup. We need to assign roles to lambda, config and setup a trigger to lambda. </p>

<p>With these steps in place, we can launch an EC2 instance that supports IMDSv1. After some time, the property will be updated to 'required,' effectively mitigating the weak configuration.</p>

<img src="../../../media/Way 2 instanc_IMDS Optional.png" height="" width="">

<p>AWS Config supports lots of issues, this was just a tip of the ice berg thing. </p>

<p>Question</p>

<p>How do you calculate the cost of the flow on AWS? Lets take the above example, I performed the same thing with two methods but I could not able to find out which is the cost effective, so how do you calculate?.</p>

<p>Please let me know on comment or you can DM me on linkedin. Would be great to know that. </p>

<p>Thanks for reading it, if you found any technical error please let me know.</p>

<p>Hope you have a great time.</p>

<p>Cheers</p>
